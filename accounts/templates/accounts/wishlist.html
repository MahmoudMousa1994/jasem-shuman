{% extends 'base.html' %}
{% load static %}

{% block title %}{{ page_title }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-lg-10 mx-auto">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="page-title">My Wishlist</h1>
                <a href="{% url 'accounts:profile' %}" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left"></i> Back to Profile
                </a>
            </div>
            
            {% if wishlist_items %}
                <div class="row">
                    {% for item in wishlist_items %}
                    <div class="col-lg-6 mb-4">
                        <div class="card wishlist-card">
                            <div class="row g-0">
                                <div class="col-md-5">
                                    <img src="{{ item.artwork.main_image.url }}" 
                                         alt="{{ item.artwork.title }}" 
                                         class="img-fluid rounded-start wishlist-image">
                                </div>
                                <div class="col-md-7">
                                    <div class="card-body">
                                        <h5 class="card-title">{{ item.artwork.title }}</h5>
                                        <p class="card-text">
                                            <span class="badge badge-gold">{{ item.get_item_type_display }}</span>
                                        </p>
                                        <p class="card-text">
                                            <strong>
                                                {% if item.item_type == 'original' %}
                                                    ${{ item.artwork.original_price }}
                                                {% else %}
                                                    ${{ item.artwork.second_option_price }}
                                                {% endif %}
                                            </strong>
                                        </p>
                                        <p class="card-text">
                                            <small class="text-muted">
                                                Added {{ item.created_at|date:"F d, Y" }}
                                            </small>
                                        </p>
                                        
                                        <div class="btn-group w-100" role="group">
                                            <a href="{% url 'gallery:artwork_detail' item.artwork.pk %}" 
                                               class="btn btn-outline-secondary btn-sm"
                                               title="View Artwork">
                                                <i class="bi bi-eye"></i>
                                            </a>
                                            <button class="btn btn-gold btn-sm add-to-cart-btn"
                                                    data-bs-toggle="modal" 
                                                    data-bs-target="#addToCartModal"
                                                    data-artwork-id="{{ item.artwork.id }}"
                                                    data-artwork-title="{{ item.artwork.title }}"
                                                    data-artwork-image="{{ item.artwork.main_image.url }}"
                                                    data-original-available="{{ item.artwork.original_available }}"
                                                    data-original-price="{{ item.artwork.original_price }}"
                                                    data-second-available="{{ item.artwork.second_option_available }}"
                                                    data-second-name="{{ item.artwork.second_option_name }}"
                                                    data-second-price="{{ item.artwork.second_option_price }}"
                                                    data-preferred-type="{{ item.item_type }}"
                                                    title="Add to Cart">
                                                <i class="bi bi-bag"></i>
                                            </button>
                                            <a href="{% url 'accounts:remove_from_wishlist' item.id %}" 
                                               class="btn btn-outline-danger btn-sm"
                                               onclick="return confirm('Remove this item from your wishlist?')"
                                               title="Remove from Wishlist">
                                                <i class="bi bi-trash"></i>
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                
                <!-- Pagination if needed -->
                {% if wishlist_items.has_other_pages %}
                <nav aria-label="Wishlist pagination">
                    <ul class="pagination justify-content-center">
                        {% if wishlist_items.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ wishlist_items.previous_page_number }}">Previous</a>
                            </li>
                        {% endif %}
                        
                        {% for num in wishlist_items.paginator.page_range %}
                            {% if wishlist_items.number == num %}
                                <li class="page-item active">
                                    <span class="page-link">{{ num }}</span>
                                </li>
                            {% else %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ num }}">{{ num }}</a>
                                </li>
                            {% endif %}
                        {% endfor %}
                        
                        {% if wishlist_items.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ wishlist_items.next_page_number }}">Next</a>
                            </li>
                        {% endif %}
                    </ul>
                </nav>
                {% endif %}
                
            {% else %}
                <!-- Empty Wishlist -->
                <div class="text-center py-5">
                    <div class="mb-4">
                        <i class="bi bi-heart display-1 text-muted"></i>
                    </div>
                    <h3 class="text-muted mb-3">Your Wishlist is Empty</h3>
                    <p class="text-muted mb-4">
                        Start adding artworks to your wishlist to keep track of pieces you love.
                    </p>
                    <div class="d-flex justify-content-center gap-3">
                        <a href="{% url 'gallery:home' %}" class="btn btn-primary">
                            <i class="bi bi-palette"></i> Browse Gallery
                        </a>
                        <a href="{% url 'store:home' %}" class="btn btn-outline-primary">
                            <i class="bi bi-shop"></i> Visit Store
                        </a>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Add to Cart Modal -->
{% include 'store/includes/add_to_cart_modal.html' %}
{% endblock %}

{% block extra_css %}
<style>
.wishlist-card {
    border: none;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    height: 100%;
}

.wishlist-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 4px 20px rgba(0,0,0,0.15);
}

.wishlist-image {
    height: 200px;
    object-fit: cover;
    width: 100%;
}

.page-title {
    font-family: 'Playfair Display', serif;
    color: #1a1a1a;
}

.card-title {
    font-family: 'Playfair Display', serif;
    font-size: 1.2rem;
    color: #1a1a1a;
}

/* Enhanced Button Styling */
.btn-group .btn {
    flex: 1;
    border-radius: 0;
    font-weight: 500;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
    width: 45px;
    height: 38px;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0;
}

.btn-group .btn:first-child {
    border-top-left-radius: 6px;
    border-bottom-left-radius: 6px;
}

.btn-group .btn:last-child {
    border-top-right-radius: 6px;
    border-bottom-right-radius: 6px;
}

/* View Button */
.btn-outline-secondary {
    color: #1a1a1a;
    border-color: #dee2e6;
    background-color: #ffffff;
}

.btn-outline-secondary:hover {
    color: #ffffff;
    background-color: #1a1a1a;
    border-color: #1a1a1a;
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(26,26,26,0.2);
}

/* Gold Add to Cart Button */
.btn-gold {
    background-color: #d4af37;
    border-color: #d4af37;
    color: #ffffff;
}

.btn-gold:hover {
    background-color: #b8941f;
    border-color: #b8941f;
    color: #ffffff;
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(212,175,55,0.3);
}

.btn-gold:focus,
.btn-gold:active {
    background-color: #b8941f;
    border-color: #b8941f;
    color: #ffffff;
}

/* Delete Button */
.btn-outline-danger {
    color: #dc3545;
    border-color: #dee2e6;
    background-color: #ffffff;
}

.btn-outline-danger:hover {
    color: #ffffff;
    background-color: #dc3545;
    border-color: #dc3545;
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(220,53,69,0.2);
}

/* Button Icons */
.btn i {
    font-size: 1rem;
    margin: 0;
}

/* Custom Badge Styling */
.badge-gold {
    background-color: #d4af37;
    color: #ffffff;
    font-size: 0.75rem;
    font-weight: 600;
    padding: 0.35em 0.65em;
    border-radius: 0.375rem;
}

/* Responsive adjustments */
@media (max-width: 576px) {
    .btn-group {
        flex-direction: row;
        gap: 5px;
    }
    
    .btn-group .btn {
        border-radius: 6px !important;
        width: 40px;
        height: 35px;
    }
}

.pagination .page-link {
    color: #1a1a1a;
    border-color: #dee2e6;
}

.pagination .page-item.active .page-link {
    background-color: #1a1a1a;
    border-color: #1a1a1a;
}

.pagination .page-link:hover {
    color: #d4af37;
    background-color: #f8f9fa;
    border-color: #d4af37;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
let currentArtwork = {};

document.addEventListener('DOMContentLoaded', function() {
    // Add to cart functionality
    document.querySelectorAll('.add-to-cart-btn').forEach(button => {
        button.addEventListener('click', function() {
            console.log('Button clicked, dataset:', this.dataset);
            
            const artworkId = this.dataset.artworkId;
            const artworkTitle = this.dataset.artworkTitle;
            const artworkImage = this.dataset.artworkImage;
            const originalAvailable = this.dataset.originalAvailable === 'True';
            const originalPrice = parseFloat(this.dataset.originalPrice) || 0;
            const secondAvailable = this.dataset.secondAvailable === 'True';
            const secondName = this.dataset.secondName;
            const secondPrice = parseFloat(this.dataset.secondPrice) || 0;
            const preferredType = this.dataset.preferredType || 'original';
            
            console.log('Parsed data:', {
                artworkId, artworkTitle, originalAvailable, originalPrice,
                secondAvailable, secondName, secondPrice, preferredType
            });
            
            // Check if modal elements exist
            const modalExists = document.getElementById('addToCartModal');
            const titleExists = document.getElementById('modal-artwork-title');
            console.log('Modal exists:', !!modalExists, 'Title element exists:', !!titleExists);
            
            // Store current artwork data
            currentArtwork = {
                id: artworkId,
                title: artworkTitle,
                image: artworkImage,
                originalAvailable: originalAvailable,
                originalPrice: originalPrice,
                secondAvailable: secondAvailable,
                secondName: secondName,
                secondPrice: secondPrice,
                preferredType: preferredType
            };
            
            // Populate modal with null checks
            const modalTitle = document.getElementById('modal-artwork-title');
            const modalImage = document.getElementById('modal-artwork-image');
            const artworkIdInput = document.getElementById('artwork-id');
            
            if (modalTitle) modalTitle.textContent = artworkTitle;
            if (modalImage) {
                modalImage.src = artworkImage;
                modalImage.alt = artworkTitle;
            }
            if (artworkIdInput) artworkIdInput.value = artworkId;
            
            // Show/hide options based on availability with null checks
            const originalOption = document.getElementById('original-option');
            const secondOption = document.getElementById('second-option');
            
            if (originalOption) {
                if (originalAvailable && originalPrice > 0) {
                    originalOption.style.display = 'block';
                    const priceElement = originalOption.querySelector('.option-price');
                    if (priceElement) priceElement.textContent = `$${originalPrice.toFixed(0)}`;
                } else {
                    originalOption.style.display = 'none';
                }
            }
            
            if (secondOption) {
                if (secondAvailable && secondPrice > 0) {
                    secondOption.style.display = 'block';
                    const nameElement = secondOption.querySelector('.option-name');
                    const priceElement = secondOption.querySelector('.option-price');
                    if (nameElement) nameElement.textContent = secondName;
                    if (priceElement) priceElement.textContent = `$${secondPrice.toFixed(0)}`;
                } else {
                    secondOption.style.display = 'none';
                }
            }
            
            // Pre-select the preferred type (from wishlist) with null checks
            const originalRadio = document.getElementById('option-original');
            const secondRadio = document.getElementById('option-second');
            const quantityInput = document.getElementById('quantity');
            
            if (originalRadio && secondRadio) {
                if (preferredType === 'original' && originalAvailable) {
                    originalRadio.checked = true;
                } else if (preferredType !== 'original' && secondAvailable) {
                    secondRadio.checked = true;
                } else {
                    // Default to first available option
                    if (originalAvailable) {
                        originalRadio.checked = true;
                    } else if (secondAvailable) {
                        secondRadio.checked = true;
                    }
                }
            }
            
            // Reset quantity
            if (quantityInput) quantityInput.value = 1;
            
            // Update price summary
            updatePriceSummary();
        });
    });
    
    // Handle quantity changes
    document.getElementById('decrease-qty')?.addEventListener('click', function() {
        const qtyInput = document.getElementById('quantity');
        const currentQty = parseInt(qtyInput.value) || 1;
        if (currentQty > 1) {
            qtyInput.value = currentQty - 1;
            updatePriceSummary();
        }
    });
    
    document.getElementById('increase-qty')?.addEventListener('click', function() {
        const qtyInput = document.getElementById('quantity');
        const currentQty = parseInt(qtyInput.value) || 1;
        if (currentQty < 10) {
            qtyInput.value = currentQty + 1;
            updatePriceSummary();
        }
    });
    
    document.getElementById('quantity')?.addEventListener('input', updatePriceSummary);
    
    // Handle option changes
    document.querySelectorAll('input[name="item_type"]').forEach(radio => {
        radio.addEventListener('change', updatePriceSummary);
    });
});

function updatePriceSummary() {
    const quantityInput = document.getElementById('quantity');
    const quantity = quantityInput ? parseInt(quantityInput.value) || 1 : 1;
    const selectedOption = document.querySelector('input[name="item_type"]:checked')?.value;
    
    let price = 0;
    if (selectedOption === 'original') {
        price = currentArtwork.originalPrice || 0;
    } else {
        price = currentArtwork.secondPrice || 0;
    }
    
    const total = price * quantity;
    
    const itemPriceEl = document.getElementById('item-price');
    const itemQuantityEl = document.getElementById('item-quantity');
    const totalPriceEl = document.getElementById('total-price');
    
    if (itemPriceEl) itemPriceEl.textContent = `$${price.toFixed(2)}`;
    if (itemQuantityEl) itemQuantityEl.textContent = quantity;
    if (totalPriceEl) totalPriceEl.textContent = `$${total.toFixed(2)}`;
}

// Handle add to cart form submission
document.getElementById('add-to-cart-form')?.addEventListener('submit', function(e) {
    e.preventDefault();
    
    const selectedOption = document.querySelector('input[name="item_type"]:checked')?.value;
    const quantity = parseInt(document.getElementById('quantity').value) || 1;
    const submitBtn = document.getElementById('confirm-add-to-cart');
    
    if (!selectedOption) {
        showMessage('Please select a purchase option', 'error');
        return;
    }
    
    // Show loading state
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Adding...';
    submitBtn.disabled = true;
    
    // Get CSRF token
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
    
    fetch('{% url "store:add_to_cart" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
            artwork_id: currentArtwork.id,
            item_type: selectedOption,
            quantity: quantity
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update cart count
            const cartCount = document.getElementById('cart-count');
            if (cartCount) {
                cartCount.textContent = data.cart_total_items || 0;
            }
            
            // Show success message
            showMessage(data.message, 'success');
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('addToCartModal'));
            if (modal) modal.hide();
        } else {
            showMessage(data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showMessage('An error occurred while adding to cart', 'error');
    })
    .finally(() => {
        // Reset button
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    });
});

function showMessage(message, type) {
    const alertClass = type === 'success' ? 'alert-success' : 
                      type === 'info' ? 'alert-info' : 'alert-danger';
    const messageHtml = `
        <div class="alert ${alertClass} alert-dismissible fade show position-fixed" 
             style="top: 20px; right: 20px; z-index: 9999; min-width: 300px;">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', messageHtml);
    
    // Auto dismiss after 5 seconds
    setTimeout(function() {
        const alerts = document.querySelectorAll('.alert');
        alerts.forEach(alert => {
            alert.style.opacity = '0';
            setTimeout(() => alert.remove(), 300);
        });
    }, 5000);
}
</script>
{% endblock %}