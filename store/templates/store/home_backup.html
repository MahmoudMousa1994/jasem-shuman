{% extends 'base.html' %}
{% load static %}

{% block title %}{{ page_title }}{% endblock %}

{% block content %}
<!-- Store Hero Section -->
<section class="hero-section">
    <div class="container">
        <div class="row align-items-center min-vh-75">
            <div class="col-lg-8 mx-auto text-center">
                <h1 class="hero-title">Art Store</h1>
                <h2 class="hero-subtitle">Original Palestinian Artworks & Sculptures</h2>
                <p class="hero-description">
                    Discover and purchase authentic Palestinian artworks, original sculptures, 
                    and limited edition prints. Each piece carries the story of Palestinian culture, 
                    heritage, and artistic excellence from internationally acclaimed artist Jasem Shuman.
                </p>
                <div class="hero-buttons">
                    <a href="#featured-artworks" class="btn btn-primary btn-lg me-3">Browse Collection</a>
                    <a href="{% url 'store:cart' %}" class="btn btn-outline-primary btn-lg">View Cart</a>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Filters and Search Section -->
<section class="filters-section py-4 bg-light">
    <div class="container">
        <form method="GET" id="filter-form" class="row g-3 align-items-end">
            <!-- Search -->
            <div class="col-md-3">
                <label for="search" class="form-label">Search Artworks</label>
                <input type="text" class="form-control" id="search" name="search" 
                       value="{{ search_query }}" placeholder="Search by title or description...">
            </div>
            
            <!-- Category Filter -->
            <div class="col-md-2">
                <label for="category" class="form-label">Category</label>
                <select class="form-select" id="category" name="category">
                    <option value="">All Categories</option>
                    {% for category in categories %}
                    <option value="{{ category.name }}" {% if category_filter and category_filter.name == category.name %}selected{% endif %}>
                        {{ category.get_name_display }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            <!-- Price Range Filter -->
            <div class="col-md-2">
                <label for="price_range" class="form-label">Price Range</label>
                <select class="form-select" id="price_range" name="price_range">
                    <option value="">All Prices</option>
                    <option value="under_500" {% if current_price_range == 'under_500' %}selected{% endif %}>Under $500</option>
                    <option value="500_1000" {% if current_price_range == '500_1000' %}selected{% endif %}>$500 - $1,000</option>
                    <option value="1000_5000" {% if current_price_range == '1000_5000' %}selected{% endif %}>$1,000 - $5,000</option>
                    <option value="over_5000" {% if current_price_range == 'over_5000' %}selected{% endif %}>Over $5,000</option>
                </select>
            </div>
            
            <!-- Sort By -->
            <div class="col-md-2">
                <label for="sort_by" class="form-label">Sort By</label>
                <select class="form-select" id="sort_by" name="sort_by">
                    <option value="title" {% if current_sort == 'title' %}selected{% endif %}>Title A-Z</option>
                    <option value="price_low" {% if current_sort == 'price_low' %}selected{% endif %}>Price: Low to High</option>
                    <option value="price_high" {% if current_sort == 'price_high' %}selected{% endif %}>Price: High to Low</option>
                    <option value="newest" {% if current_sort == 'newest' %}selected{% endif %}>Newest First</option>
                    <option value="oldest" {% if current_sort == 'oldest' %}selected{% endif %}>Oldest First</option>
                </select>
            </div>
            
            <!-- Filter Buttons -->
            <div class="col-md-3">
                <div class="btn-group w-100" role="group">
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-funnel"></i> Filter
                    </button>
                    <a href="{% url 'store:home' %}" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-clockwise"></i> Reset
                    </a>
                </div>
            </div>
        </form>
        
        <!-- Results Info -->
        {% if show_all_artworks %}
        <div class="row mt-3">
            <div class="col-12">
                <div class="alert alert-info mb-0">
                    <i class="bi bi-info-circle me-2"></i>
                    Showing {{ total_artworks }} artwork{{ total_artworks|pluralize }}
                    {% if search_query %}matching "{{ search_query }}"{% endif %}
                    {% if category_filter %}in {{ category_filter.get_name_display }}{% endif %}
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</section>

{% if not show_all_artworks %}
<!-- Categories Section -->
<section class="categories-section py-5">
    <div class="container">
        <div class="row mb-5">
            <div class="col-lg-8 mx-auto text-center">
                <h2 class="section-title">Shop by Collection</h2>
                <p class="section-subtitle">
                    Explore our diverse range of artistic expressions, from large-scale sculptures 
                    to intimate paintings, each telling a unique Palestinian story
                </p>
            </div>
        </div>
        
        <div class="row">
            {% for category in categories %}
            <div class="col-md-6 mb-4">
                <div class="category-card store-category">
                    <div class="category-content">
                        <h3 class="category-title">{{ category.get_name_display }}</h3>
                        <p class="category-description">{{ category.description|default:"Explore our collection of authentic Palestinian art" }}</p>
                        <div class="category-stats">
                            <span class="artwork-count">{{ category.artwork_set.count }} artwork{{ category.artwork_set.count|pluralize }}</span>
                        </div>
                        <a href="{% url 'store:home' %}?category={{ category.name }}" class="btn btn-outline-primary btn-sm">
                            Browse {{ category.get_name_display }}
                        </a>
                    </div>
                </div>
            </div>
            {% empty %}
            <div class="col-12">
                <div class="text-center py-5">
                    <p class="text-muted">Collections will be displayed here once artworks are added.</p>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</section>
{% endif %}

<!-- Featured Artworks Section -->
<section class="featured-artworks py-5" id="featured-artworks">
    <div class="container">
        <div class="row mb-5">
            <div class="col-lg-8 mx-auto text-center">
                {% if show_all_artworks %}
                    <h2 class="section-title">Search Results</h2>
                    <p class="section-subtitle">
                        {% if search_query %}
                            Artworks matching "{{ search_query }}"
                        {% elif category_filter %}
                            {{ category_filter.get_name_display }} Collection
                        {% else %}
                            Filtered Artworks
                        {% endif %}
                    </p>
                {% else %}
                    <h2 class="section-title">Featured Artworks</h2>
                    <p class="section-subtitle">
                        Original pieces and limited editions available for purchase
                    </p>
                {% endif %}
            </div>
        </div>
        
        {% if featured_artworks %}
        <div class="row">
            {% for artwork in featured_artworks %}
            <div class="col-lg-3 col-md-6 mb-4">
                <div class="artwork-card store-artwork">
                    <div class="artwork-image">
                        {% if artwork.main_image %}
                            <img src="{{ artwork.main_image.url }}" 
                                 alt="{{ artwork.title }}"
                                 class="store-artwork-img">
                        {% else %}
                            <div class="placeholder-image">
                                <span>No Image</span>
                            </div>
                        {% endif %}
                        
                        <!-- Availability Overlay -->
                        {% if not artwork.original_available %}
                        <div class="availability-overlay">
                            <span class="sold-badge">Sold</span>
                        </div>
                        {% endif %}
                    </div>
                    
                    <div class="artwork-info">
                        <h4 class="artwork-title">{{ artwork.title }}</h4>
                        <p class="artwork-year">{{ artwork.artwork_creation_date.year }}</p>
                        <p class="artwork-dimensions">{{ artwork.original_dimensions_display }}</p>
                        
                        <div class="artwork-pricing">
                            {% if artwork.original_available and artwork.original_price %}
                            <div class="price-option">
                                <span class="price-label">Original:</span>
                                <span class="price">${{ artwork.original_price }}</span>
                            </div>
                            {% endif %}
                            {% if artwork.second_option_available and artwork.second_option_price %}
                            <div class="price-option">
                                <span class="price-label">{{ artwork.second_option_name }}:</span>
                                <span class="price">${{ artwork.second_option_price }}</span>
                            </div>
                            {% endif %}
                        </div>
                        
                        <div class="artwork-actions">
                            <a href="{% url 'gallery:artwork_detail' artwork.id %}" 
                               class="btn btn-outline-primary btn-sm">View Details</a>
                            {% if artwork.original_available or artwork.second_option_available %}
                            <button class="btn btn-primary btn-sm add-to-cart-btn ms-2"
                                    data-bs-toggle="modal" 
                                    data-bs-target="#addToCartModal"
                                    data-artwork-id="{{ artwork.id }}"
                                    data-artwork-title="{{ artwork.title }}"
                                    data-artwork-image="{{ artwork.main_image.url }}"
                                    data-original-available="{{ artwork.original_available }}"
                                    data-original-price="{{ artwork.original_price }}"
                                    data-second-available="{{ artwork.second_option_available }}"
                                    data-second-name="{{ artwork.second_option_name }}"
                                    data-second-price="{{ artwork.second_option_price }}">
                                Add to Cart
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="text-center py-5 no-results-state">
            {% if search_query or category_filter or price_filter or sort %}
            <div class="mb-4">
                <i class="fas fa-search-minus fa-3x mb-3"></i>
                <h4>No artworks match your filters</h4>
                <p class="text-muted mb-3">Try adjusting your search criteria or filters to find what you're looking for.</p>
                
                <div class="d-flex flex-wrap justify-content-center gap-2 mb-3">
                    {% if search_query %}
                    <span class="badge">
                        <i class="fas fa-search me-1"></i>Search: "{{ search_query }}"
                    </span>
                    {% endif %}
                    {% if category_filter %}
                    <span class="badge">
                        <i class="fas fa-tag me-1"></i>Category: {{ category_filter.name }}
                    </span>
                    {% endif %}
                    {% if price_filter %}
                    <span class="badge">
                        <i class="fas fa-dollar-sign me-1"></i>Price: 
                        {% if price_filter == 'under_500' %}Under $500
                        {% elif price_filter == '500_1000' %}$500 - $1,000
                        {% elif price_filter == '1000_5000' %}$1,000 - $5,000
                        {% elif price_filter == 'over_5000' %}Over $5,000
                        {% endif %}
                    </span>
                    {% endif %}
                </div>
                
                <a href="{% url 'store:home' %}" class="btn btn-outline-primary me-2">
                    <i class="fas fa-times me-1"></i>Clear All Filters
                </a>
                <a href="{% url 'gallery:home' %}" class="btn btn-primary">
                    <i class="fas fa-images me-1"></i>Browse Gallery
                </a>
            </div>
            {% else %}
            <div class="mb-4">
                <i class="fas fa-palette fa-3x mb-3"></i>
                <h4>No artworks available for purchase yet</h4>
                <p class="text-muted mb-4">Please check back soon for new additions to our collection.</p>
                <a href="{% url 'gallery:home' %}" class="btn btn-primary">
                    <i class="fas fa-images me-1"></i>Browse Gallery
                </a>
            </div>
            {% endif %}
        </div>
        {% endif %}
        
        {% if featured_artworks %}
        <div class="text-center mt-5">
            <a href="{% url 'gallery:home' %}" class="btn btn-outline-primary btn-lg">
                View Complete Gallery
            </a>
        </div>
        {% endif %}
    </div>
</section>

<!-- Store Information Section -->
<section class="store-info py-5">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 mx-auto text-center">
                <h3 class="section-title">Why Choose Our Art</h3>
                <p class="section-subtitle">
                    Every purchase supports Palestinian artists and helps preserve cultural heritage
                </p>
            </div>
        </div>
        
        <div class="row text-center mt-5">
            <div class="col-md-3 mb-4">
                <div class="info-item">
                    <div class="info-icon">üé®</div>
                    <h5>Authentic Art</h5>
                    <p class="text-muted">Original works by acclaimed Palestinian artist</p>
                </div>
            </div>
            <div class="col-md-3 mb-4">
                <div class="info-item">
                    <div class="info-icon">üèÜ</div>
                    <h5>Award Winning</h5>
                    <p class="text-muted">Internationally recognized and exhibited</p>
                </div>
            </div>
            <div class="col-md-3 mb-4">
                <div class="info-item">
                    <div class="info-icon">üìú</div>
                    <h5>Certificate</h5>
                    <p class="text-muted">Comes with authenticity documentation</p>
                </div>
            </div>
            <div class="col-md-3 mb-4">
                <div class="info-item">
                    <div class="info-icon">üöö</div>
                    <h5>Secure Shipping</h5>
                    <p class="text-muted">Professional packaging and insured delivery</p>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

<!-- Add to Cart Modal -->
<div class="modal fade" id="addToCartModal" tabindex="-1" aria-labelledby="addToCartModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addToCartModalLabel">Add to Cart</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="container-fluid">
                    <div class="row">
                        <!-- Artwork Image -->
                        <div class="col-md-5">
                            <img id="modalArtworkImage" src="" alt="Artwork" class="img-fluid rounded shadow-sm">
                        </div>
                        
                        <!-- Purchase Options -->
                        <div class="col-md-7">
                            <h4 id="modalArtworkTitle" class="mb-3"></h4>
                            
                            <!-- Purchase Type Selection -->
                            <div class="mb-4">
                                <label class="form-label">Select Purchase Type:</label>
                                <div id="purchaseOptions">
                                    <!-- Options will be populated by JavaScript -->
                                </div>
                            </div>
                            
                            <!-- Quantity Selection -->
                            <div class="mb-4">
                                <label for="quantity" class="form-label">Quantity:</label>
                                <div class="input-group" style="max-width: 150px;">
                                    <button class="btn btn-outline-secondary" type="button" id="decreaseQty">-</button>
                                    <input type="number" class="form-control text-center" id="quantity" value="1" min="1" max="10">
                                    <button class="btn btn-outline-secondary" type="button" id="increaseQty">+</button>
                                </div>
                            </div>
                            
                            <!-- Price Summary -->
                            <div class="card bg-light">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>Item Price:</span>
                                        <span id="itemPrice">$0.00</span>
                                    </div>
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>Quantity:</span>
                                        <span id="itemQuantity">1</span>
                                    </div>
                                    <hr>
                                    <div class="d-flex justify-content-between fw-bold">
                                        <span>Total:</span>
                                        <span id="totalPrice">$0.00</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmAddToCart">
                    <i class="bi bi-cart-plus me-2"></i>Add to Cart
                </button>
            </div>
        </div>
    </div>
</div>

{% block extra_js %}
<script>
// Store filters auto-submit functionality
$(document).ready(function() {
    // Auto-submit form when filters change (except search)
    $('#category, #price_range, #sort_by').on('change', function() {
        $('#filter-form').submit();
    });
    
    // Search with debounce
    let searchTimeout;
    $('#search').on('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(function() {
            $('#filter-form').submit();
        }, 1000); // Wait 1 second after user stops typing
    });
    
    // Clear search on escape
    $('#search').on('keydown', function(e) {
        if (e.key === 'Escape') {
            $(this).val('');
            $('#filter-form').submit();
        }
    });
});

// Add to cart modal functionality
$(document).ready(function() {
    let currentArtwork = null;
    let selectedType = 'original';
    
    // Handle modal show event
    $('#addToCartModal').on('show.bs.modal', function (event) {
        const button = $(event.relatedTarget);
        
        // Extract data from button
        currentArtwork = {
            id: button.data('artwork-id'),
            title: button.data('artwork-title'),
            image: button.data('artwork-image'),
            originalAvailable: button.data('original-available'),
            originalPrice: parseFloat(button.data('original-price')) || 0,
            secondAvailable: button.data('second-available'),
            secondName: button.data('second-name'),
            secondPrice: parseFloat(button.data('second-price')) || 0
        };
        
        // Update modal content
        $('#modalArtworkTitle').text(currentArtwork.title);
        $('#modalArtworkImage').attr('src', currentArtwork.image);
        
        // Generate purchase options
        let optionsHtml = '';
        
        if (currentArtwork.originalAvailable && currentArtwork.originalPrice > 0) {
            optionsHtml += `
                <div class="form-check mb-2">
                    <input class="form-check-input" type="radio" name="purchaseType" id="originalOption" value="original" checked>
                    <label class="form-check-label" for="originalOption">
                        <strong>Original Artwork</strong> - $${currentArtwork.originalPrice.toFixed(2)}
                        <br><small class="text-muted">One-of-a-kind original piece</small>
                    </label>
                </div>
            `;
            selectedType = 'original';
        }
        
        if (currentArtwork.secondAvailable && currentArtwork.secondPrice > 0) {
            const isChecked = !currentArtwork.originalAvailable || currentArtwork.originalPrice <= 0;
            optionsHtml += `
                <div class="form-check mb-2">
                    <input class="form-check-input" type="radio" name="purchaseType" id="secondOption" value="second" ${isChecked ? 'checked' : ''}>
                    <label class="form-check-label" for="secondOption">
                        <strong>${currentArtwork.secondName}</strong> - $${currentArtwork.secondPrice.toFixed(2)}
                        <br><small class="text-muted">High-quality reproduction</small>
                    </label>
                </div>
            `;
            if (isChecked) selectedType = 'second';
        }
        
        $('#purchaseOptions').html(optionsHtml);
        
        // Update pricing
        updatePricing();
    });
    
    // Handle purchase type change
    $(document).on('change', 'input[name="purchaseType"]', function() {
        selectedType = $(this).val();
        updatePricing();
    });
    
    // Handle quantity changes
    $('#decreaseQty').click(function() {
        const qty = parseInt($('#quantity').val());
        if (qty > 1) {
            $('#quantity').val(qty - 1);
            updatePricing();
        }
    });
    
    $('#increaseQty').click(function() {
        const qty = parseInt($('#quantity').val());
        if (qty < 10) {
            $('#quantity').val(qty + 1);
            updatePricing();
        }
    });
    
    $('#quantity').on('input', function() {
        updatePricing();
    });
    
    function updatePricing() {
        const quantity = parseInt($('#quantity').val()) || 1;
        let unitPrice = 0;
        
        if (selectedType === 'original') {
            unitPrice = currentArtwork.originalPrice;
        } else if (selectedType === 'second') {
            unitPrice = currentArtwork.secondPrice;
        }
        
        const total = unitPrice * quantity;
        
        $('#itemPrice').text(`$${unitPrice.toFixed(2)}`);
        $('#itemQuantity').text(quantity);
        $('#totalPrice').text(`$${total.toFixed(2)}`);
    }
    
    // Handle add to cart confirmation
    $('#confirmAddToCart').click(function() {
        const button = $(this);
        const originalText = button.html();
        
        // Show loading state
        button.html('<span class="spinner-border spinner-border-sm me-2"></span>Adding...');
        button.prop('disabled', true);
        
        // Prepare data
        const data = {
            artwork_id: currentArtwork.id,
            item_type: selectedType,
            quantity: parseInt($('#quantity').val()) || 1
        };
        
        // Make AJAX request
        $.ajax({
            url: '/store/add-to-cart/',
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            },
            data: JSON.stringify(data),
            success: function(data) {
                if (data.success) {
                    // Update cart count
                    if ($('#cart-count').length) {
                        $('#cart-count').text(data.cart_total_items || 0);
                    }
                    
                    // Show success message
                    showMessage(data.message, 'success');
                    
                    // Close modal
                    $('#addToCartModal').modal('hide');
                } else {
                    showMessage(data.message, 'error');
                }
            },
            error: function() {
                showMessage('An error occurred. Please try again.', 'error');
            },
            complete: function() {
                // Reset button
                button.html(originalText);
                button.prop('disabled', false);
            }
        });
    });
});

// Helper function to get CSRF token from cookies
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Message system
function showMessage(message, type = 'info') {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.top = '100px';
    alertDiv.style.right = '20px';
    alertDiv.style.zIndex = '9999';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alertDiv);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}
</script>
{% endblock %}