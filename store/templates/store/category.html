{% extends 'base.html' %}
{% load static %}

{% block title %}{{ page_title }}{% endblock %}

{% block content %}
<!-- Category Hero Section -->
<section class="hero-section">
    <div class="container">
        <div class="row align-items-center min-vh-75">
            <div class="col-lg-8 mx-auto text-center">
                <h1 class="hero-title">{{ category.get_name_display }}</h1>
                <h2 class="hero-subtitle">Palestinian {{ category.get_name_display }}s</h2>
                <p class="hero-description">
                    {% if category.name == 'painting' %}
                    Explore our collection of authentic Palestinian paintings, each piece capturing the essence of Palestinian culture, history, and artistic vision through vibrant colors and masterful brushwork.
                    {% elif category.name == 'sculpture' %}
                    Discover our stunning sculptures that embody the spirit of Palestinian artistry, from traditional motifs to contemporary expressions, each piece crafted with passion and cultural significance.
                    {% else %}
                    Discover our collection of authentic Palestinian artworks, each piece telling a unique story of culture, heritage, and artistic excellence.
                    {% endif %}
                </p>
                <div class="hero-buttons">
                    <a href="#artworks" class="btn btn-primary btn-lg me-3">Browse Collection</a>
                    <a href="{% url 'store:cart' %}" class="btn btn-outline-primary btn-lg">View Cart</a>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Artworks Section -->
<section id="artworks" class="artworks-section py-5">
    <div class="container">
        <div class="row mb-5">
            <div class="col-lg-8 mx-auto text-center">
                <h2 class="section-title">{{ category.get_name_display }} Collection</h2>
                <p class="section-subtitle">
                    {% if artwork_count > 0 %}
                    Showing {{ artwork_count }} {{ category.get_name_display|lower }}{{ artwork_count|pluralize }} available for purchase
                    {% else %}
                    No {{ category.get_name_display|lower }}s available for purchase at this time
                    {% endif %}
                </p>
            </div>
        </div>
        
        {% if artworks %}
        <div class="row">
            {% for artwork in artworks %}
            <div class="col-lg-3 col-md-4 col-sm-6 mb-4">
                <div class="artwork-card">
                    <div class="artwork-image">
                        <img src="{{ artwork.main_image.url }}" alt="{{ artwork.title }}" class="card-img-top">
                        <div class="artwork-overlay">
                            <a href="{{ artwork.get_absolute_url }}" class="btn btn-primary btn-sm">
                                View Details
                            </a>
                        </div>
                    </div>
                    <div class="artwork-info">
                        <h5 class="artwork-title">{{ artwork.title }}</h5>
                        <p class="artwork-year">{{ artwork.artwork_creation_date.year }}</p>
                        <div class="artwork-prices">
                            {% if artwork.original_available %}
                            <div class="price-option">
                                <span class="price-label">Original:</span>
                                <span class="price">${{ artwork.original_price|floatformat:0 }}</span>
                            </div>
                            {% endif %}
                            {% if artwork.second_option_available and artwork.second_option_price %}
                            <div class="price-option">
                                <span class="price-label">{{ artwork.second_option_name }}:</span>
                                <span class="price">${{ artwork.second_option_price|floatformat:0 }}</span>
                            </div>
                            {% endif %}
                        </div>
                        <div class="artwork-actions">
                            <div class="btn-group w-100" role="group">
                                {% if artwork.original_available or artwork.second_option_available %}
                                <button class="btn btn-primary btn-sm add-to-cart-btn"
                                        data-bs-toggle="modal" 
                                        data-bs-target="#addToCartModal"
                                        data-artwork-id="{{ artwork.id }}"
                                        data-artwork-title="{{ artwork.title }}"
                                        data-artwork-image="{{ artwork.main_image.url }}"
                                        data-original-available="{{ artwork.original_available }}"
                                        data-original-price="{{ artwork.original_price }}"
                                        data-second-available="{{ artwork.second_option_available }}"
                                        data-second-name="{{ artwork.second_option_name }}"
                                        data-second-price="{{ artwork.second_option_price }}">
                                    <i class="bi bi-bag"></i> Add to Cart
                                </button>
                                {% endif %}
                                <button class="btn btn-gold btn-sm wishlist-btn"
                                        data-artwork-id="{{ artwork.id }}">
                                    <i class="bi bi-heart"></i> Add to Wishlist
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="text-center py-5">
            <div class="mb-4">
                {% if category.name == 'painting' %}
                <i class="fas fa-palette fa-3x mb-3 text-muted"></i>
                {% elif category.name == 'sculpture' %}
                <i class="fas fa-cubes fa-3x mb-3 text-muted"></i>
                {% else %}
                <i class="fas fa-images fa-3x mb-3 text-muted"></i>
                {% endif %}
                <h4>No {{ category.get_name_display|lower }}s available yet</h4>
                <p class="text-muted mb-4">Please check back soon for new additions to our {{ category.get_name_display|lower }} collection.</p>
                <a href="{% url 'store:home' %}" class="btn btn-outline-primary me-2">
                    Browse Other Categories
                </a>
                <a href="{% url 'gallery:home' %}" class="btn btn-primary">
                    View Gallery
                </a>
            </div>
        </div>
        {% endif %}
        
        <!-- Back to Store -->
        <div class="text-center mt-5">
            <a href="{% url 'store:home' %}" class="btn btn-outline-secondary me-3">
                <i class="fas fa-arrow-left me-1"></i>Back to Store
            </a>
            <a href="{% url 'gallery:home' %}" class="btn btn-outline-primary">
                View Complete Gallery
            </a>
        </div>
    </div>
</section>

<!-- Category Information -->
<section class="category-info py-5 bg-light">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 mx-auto text-center">
                {% if category.name == 'painting' %}
                <h2 class="section-title">About Our Paintings</h2>
                <p class="section-subtitle mb-4">
                    Each painting in our collection represents a unique perspective on Palestinian identity, culture, and experience.
                </p>
                <div class="row">
                    <div class="col-md-6 mb-4">
                        <h4>Original Paintings</h4>
                        <p>One-of-a-kind artworks created by Jasem Shuman, painted with traditional and contemporary techniques on high-quality canvas.</p>
                    </div>
                    <div class="col-md-6 mb-4">
                        <h4>Print Copies</h4>
                        <p>Limited edition prints (50 copies max) on archival paper, maintaining the vibrancy and detail of the original paintings.</p>
                    </div>
                </div>
                {% elif category.name == 'sculpture' %}
                <h2 class="section-title">About Our Sculptures</h2>
                <p class="section-subtitle mb-4">
                    Our sculptures embody the three-dimensional essence of Palestinian artistic expression.
                </p>
                <div class="row">
                    <div class="col-md-6 mb-4">
                        <h4>Original Sculptures</h4>
                        <p>Unique three-dimensional artworks crafted by Jasem Shuman using various materials and traditional sculpting techniques.</p>
                    </div>
                    <div class="col-md-6 mb-4">
                        <h4>Signed Photo Sets</h4>
                        <p>Professional photography sets (50 copies max) showcasing multiple angles of the sculpture, personally signed by the artist.</p>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</section>

<!-- Add to Cart Modal -->
{% include 'store/includes/add_to_cart_modal.html' %}

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    let currentArtwork = null;
    
    // Add to cart functionality
    document.querySelectorAll('.add-to-cart-btn').forEach(button => {
        button.addEventListener('click', function() {
            const artworkId = this.dataset.artworkId;
            const artworkTitle = this.dataset.artworkTitle;
            const artworkImage = this.dataset.artworkImage;
            const originalAvailable = this.dataset.originalAvailable === 'True';
            const originalPrice = parseFloat(this.dataset.originalPrice) || 0;
            const secondAvailable = this.dataset.secondAvailable === 'True';
            const secondName = this.dataset.secondName;
            const secondPrice = parseFloat(this.dataset.secondPrice) || 0;
            
            // Store current artwork data
            currentArtwork = {
                id: artworkId,
                title: artworkTitle,
                image: artworkImage,
                originalAvailable: originalAvailable,
                originalPrice: originalPrice,
                secondAvailable: secondAvailable,
                secondName: secondName,
                secondPrice: secondPrice
            };
            
            // Populate modal
            document.getElementById('modal-artwork-title').textContent = artworkTitle;
            document.getElementById('modal-artwork-image').src = artworkImage;
            document.getElementById('modal-artwork-image').alt = artworkTitle;
            
            // Set hidden artwork ID
            document.getElementById('artwork-id').value = artworkId;
            
            // Show/hide options based on availability
            const originalOption = document.getElementById('original-option');
            const secondOption = document.getElementById('second-option');
            
            if (originalAvailable && originalPrice > 0) {
                originalOption.style.display = 'block';
                originalOption.querySelector('.option-price').textContent = `$${originalPrice.toFixed(0)}`;
            } else {
                originalOption.style.display = 'none';
            }
            
            if (secondAvailable && secondPrice > 0) {
                secondOption.style.display = 'block';
                secondOption.querySelector('.option-name').textContent = secondName;
                secondOption.querySelector('.option-price').textContent = `$${secondPrice.toFixed(0)}`;
            } else {
                secondOption.style.display = 'none';
            }
            
            // Select first available option
            if (originalAvailable && originalPrice > 0) {
                document.getElementById('option-original').checked = true;
            } else if (secondAvailable && secondPrice > 0) {
                document.getElementById('option-second').checked = true;
            }
            
            // Reset quantity
            document.getElementById('quantity').value = 1;
            
            // Update pricing
            updatePricing();
        });
    });
    
    // Handle quantity changes
    document.getElementById('decrease-qty').addEventListener('click', function() {
        const qtyInput = document.getElementById('quantity');
        const currentQty = parseInt(qtyInput.value);
        if (currentQty > 1) {
            qtyInput.value = currentQty - 1;
            updatePricing();
        }
    });
    
    document.getElementById('increase-qty').addEventListener('click', function() {
        const qtyInput = document.getElementById('quantity');
        const currentQty = parseInt(qtyInput.value);
        if (currentQty < 10) {
            qtyInput.value = currentQty + 1;
            updatePricing();
        }
    });
    
    document.getElementById('quantity').addEventListener('input', updatePricing);
    
    // Handle option type changes
    document.querySelectorAll('input[name="item_type"]').forEach(radio => {
        radio.addEventListener('change', updatePricing);
    });
    
    // Update pricing function
    function updatePricing() {
        if (!currentArtwork) return;
        
        const quantity = parseInt(document.getElementById('quantity').value) || 1;
        const selectedType = document.querySelector('input[name="item_type"]:checked')?.value;
        
        let unitPrice = 0;
        if (selectedType === 'original') {
            unitPrice = currentArtwork.originalPrice;
        } else if (selectedType === 'second') {
            unitPrice = currentArtwork.secondPrice;
        }
        
        const total = unitPrice * quantity;
        
        document.getElementById('item-price').textContent = `$${unitPrice.toFixed(2)}`;
        document.getElementById('item-quantity').textContent = quantity;
        document.getElementById('total-price').textContent = `$${total.toFixed(2)}`;
    }
    
    // Handle add to cart form submission
    document.getElementById('add-to-cart-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const data = {
            artwork_id: formData.get('artwork_id'),
            item_type: formData.get('item_type'),
            quantity: formData.get('quantity')
        };
        
        // Validate selection
        if (!data.item_type) {
            alert('Please select a purchase option');
            return;
        }
        
        const submitBtn = document.getElementById('confirm-add-to-cart');
        const originalText = submitBtn.innerHTML;
        
        // Show loading state
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Adding...';
        submitBtn.disabled = true;
        
        fetch('{% url "store:add_to_cart" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update cart counter
                const cartCounter = document.querySelector('.cart-counter');
                if (cartCounter) {
                    cartCounter.textContent = data.cart_total_items;
                    cartCounter.style.display = data.cart_total_items > 0 ? 'block' : 'none';
                }
                
                // Show success message
                showMessage(data.message, 'success');
                
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('addToCartModal'));
                modal.hide();
            } else {
                showMessage(data.message, 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showMessage('An error occurred while adding to cart', 'error');
        })
        .finally(() => {
            // Reset button
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        });
    });
    
    // Add to wishlist functionality
    document.querySelectorAll('.wishlist-btn').forEach(button => {
        button.addEventListener('click', function() {
            const artworkId = this.dataset.artworkId;
            const originalHtml = this.innerHTML;
            
            // Show loading state
            this.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Adding...';
            this.disabled = true;
            
            fetch(`/account/wishlist/add/${artworkId}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: 'item_type=original'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showMessage(data.message, 'success');
                    
                    // Change button to "Added" state temporarily
                    this.innerHTML = '<i class="bi bi-heart-fill"></i> Added to Wishlist';
                    this.classList.remove('btn-gold');
                    this.classList.add('btn-success');
                    
                    // Revert after 3 seconds
                    setTimeout(() => {
                        this.innerHTML = originalHtml;
                        this.classList.remove('btn-success');
                        this.classList.add('btn-gold');
                        this.disabled = false;
                    }, 3000);
                } else {
                    showMessage(data.message, 'error');
                    this.innerHTML = originalHtml;
                    this.disabled = false;
                }
            })
            .catch(error => {
                if (error.message.includes('403') || error.message.includes('401')) {
                    showMessage('Please log in to add items to your wishlist', 'info');
                    window.location.href = '/accounts/login/?next=' + encodeURIComponent(window.location.pathname);
                } else {
                    showMessage('An error occurred while adding to wishlist', 'error');
                }
                this.innerHTML = originalHtml;
                this.disabled = false;
            });
        });
    });

    // Message system
    function showMessage(message, type = 'info') {
        const alertType = type === 'error' ? 'danger' : type;
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${alertType} alert-dismissible fade show position-fixed`;
        alertDiv.style.top = '100px';
        alertDiv.style.right = '20px';
        alertDiv.style.zIndex = '9999';
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        document.body.appendChild(alertDiv);
        
        // Auto-remove after 5 seconds
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, 5000);
    }
});
</script>
{% endblock %}

{% block extra_css %}
<style>
/* Gold Button Styling */
.btn-gold {
    background-color: #d4af37;
    border-color: #d4af37;
    color: #ffffff;
}

.btn-gold:hover {
    background-color: #b8941f;
    border-color: #b8941f;
    color: #ffffff;
}

.btn-gold:focus,
.btn-gold:active {
    background-color: #b8941f;
    border-color: #b8941f;
    color: #ffffff;
}

/* Button group adjustments */
.btn-group .btn {
    flex: 1;
}
</style>
{% endblock %}